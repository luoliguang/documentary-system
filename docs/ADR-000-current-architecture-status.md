# ADR-000: 当前架构现状记录

**状态**: Accepted（但需要持续优化）  
**日期**: 2024年  
**决策者**: 架构团队  
**上下文**: 记录跟单系统当前架构现状，作为后续架构演进的基准

---

## 上下文

跟单系统是一个用于服装行业订单管理的Web应用，采用前后端分离架构。系统需要支持三种角色（管理员、生产跟单、客户）的协作，实现从订单创建到出货的完整流程。

当前系统已经实现了核心功能，但存在一些架构问题和改进空间。本文档记录当前架构的现状，作为后续优化的基准。

---

## 当前架构决策

### 1. 技术栈选择

**决策**: 采用以下技术栈
- **前端**: Vue 3 + TypeScript + Vite + Element Plus + Pinia
- **后端**: Node.js + Express + TypeScript
- **数据库**: PostgreSQL
- **认证**: JWT (JSON Web Token)
- **存储**: 阿里云OSS（图片存储）

**理由**:
- Vue 3提供良好的开发体验和性能
- Express是Node.js生态成熟的Web框架
- PostgreSQL提供强大的关系型数据管理能力
- JWT适合前后端分离架构的认证需求

**权衡**:
- ✅ 技术栈成熟，社区支持好
- ✅ 开发效率高
- ❌ 缺少微服务支持（当前为单体应用）
- ❌ 缺少消息队列（当前为同步处理）

---

### 2. 架构模式

**决策**: 采用分层架构（Layered Architecture）

```
前端层 (Presentation Layer)
    ↓
API层 (API Layer / Routes)
    ↓
控制器层 (Controller Layer)
    ↓
服务层 (Service Layer)
    ↓
数据访问层 (Data Access Layer / Database)
```

**理由**:
- 职责清晰，易于理解和维护
- 适合中小型项目
- 便于团队协作

**权衡**:
- ✅ 结构清晰，易于上手
- ✅ 适合当前团队规模
- ❌ 随着业务增长，可能出现层级过深的问题
- ❌ 缺少领域模型层（DDD）

---

### 3. 权限控制

**决策**: 采用基于角色的访问控制（RBAC）

**实现方式**:
- JWT Token认证
- 中间件层权限检查
- 数据访问层数据过滤
- 配置表动态权限管理

**理由**:
- RBAC是成熟的权限模型
- 支持动态权限配置
- 易于扩展新角色

**权衡**:
- ✅ 权限模型清晰
- ✅ 支持动态配置
- ❌ 权限检查逻辑分散（需要优化）
- ❌ 缺少细粒度权限控制（如字段级权限）

---

### 4. 数据存储

**决策**: 使用PostgreSQL关系型数据库

**理由**:
- 数据结构关系复杂（订单、用户、跟进记录等）
- 需要事务支持
- 需要复杂查询（JOIN、聚合等）

**权衡**:
- ✅ 数据一致性保证
- ✅ 复杂查询支持
- ❌ 扩展性受限（单机数据库）
- ❌ 缺少读写分离

---

### 5. 文件存储

**决策**: 使用阿里云OSS存储订单图片

**理由**:
- 避免服务器存储压力
- 支持CDN加速
- 成本可控

**权衡**:
- ✅ 存储成本低
- ✅ 访问速度快
- ❌ 依赖外部服务
- ❌ 缺少本地备份

---

## 已知问题

### 严重问题

1. **数据库表定义不完整**
   - `order_follow_ups`、`notifications`、`system_configs`表未在schema.sql中定义
   - 影响：新环境部署困难

2. **代码重复**
   - 权限检查逻辑重复
   - 订单状态值散落多处
   - 影响：维护困难，容易出错

3. **缺少审计日志**
   - 无法追踪操作历史
   - 影响：安全审计困难

### 中等问题

4. **缺少输入验证**
   - Zod已安装但未使用
   - 影响：数据质量风险

5. **错误处理不统一**
   - 错误处理逻辑分散
   - 影响：用户体验不一致

6. **缺少事务管理**
   - 部分操作缺少事务
   - 影响：数据一致性风险

### 轻微问题

7. **缺少测试**
   - 没有单元测试和集成测试
   - 影响：重构风险高

8. **缺少文档**
   - 没有API文档
   - 影响：协作效率低

---

## 后续优化方向

1. **短期（1-3个月）**
   - 修复数据库表定义问题
   - 重构权限检查逻辑
   - 添加输入验证
   - 统一错误处理

2. **中期（3-6个月）**
   - 引入事件驱动架构
   - 实现可插拔模块
   - 添加审计日志
   - 完善测试覆盖

3. **长期（6个月以上）**
   - 微服务化准备
   - 实现读写分离
   - 添加性能监控
   - 实现自动化部署

---

## 后果

### 正面影响

- ✅ 当前架构满足业务需求
- ✅ 技术栈成熟稳定
- ✅ 开发效率较高

### 负面影响

- ❌ 代码质量有待提升
- ❌ 缺少测试保护
- ❌ 扩展性受限

### 风险

- 🔴 数据库表定义不完整可能导致部署失败
- 🟡 代码重复可能导致维护困难
- 🟡 缺少测试可能导致重构风险

---

## 状态

**当前状态**: Accepted（但需要持续优化）

本架构决策记录当前架构的现状，作为后续优化的基准。随着业务发展和团队成长，需要持续优化架构，解决已知问题。

---

## 相关文档

- [ARCHITECTURE.md](../ARCHITECTURE.md) - 完整架构文档
- [架构演进路线图](./architecture-roadmap.md) - 未来6个月演进计划

