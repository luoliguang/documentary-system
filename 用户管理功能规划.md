# 用户管理功能规划方案

## 一、需求概述

### 1.1 核心需求
1. **用户自主修改**：用户可以修改自己的名字（contact_name）
2. **管理员备注**：管理员可以为用户添加备注（admin_notes），用于标识具体客户
3. **管理员权限**：管理员可以创建、编辑、删除、禁用所有用户账号

### 1.2 用户角色
- **管理员（admin）**：拥有所有权限
- **生产跟单（production_manager）**：可以修改自己的信息
- **客户（customer）**：可以修改自己的信息

## 二、数据库结构变更

### 2.1 用户表扩展
```sql
-- 添加管理员备注字段
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS admin_notes TEXT;

-- 添加注释
COMMENT ON COLUMN users.admin_notes IS '管理员备注，用于标识具体客户信息';
```

## 三、功能设计

### 3.1 用户个人中心（所有用户）
- **可修改字段**：
  - 联系人姓名（contact_name）
  - 邮箱（email）
  - 电话（phone）
  - 密码（password）
- **只读字段**：
  - 用户名（username）
  - 客户编号（customer_code）
  - 公司名称（company_name）- 仅客户
  - 角色（role）
  - 管理员备注（admin_notes）- 仅管理员可见

### 3.2 用户管理页面（仅管理员）
- **功能列表**：
  1. 用户列表（表格展示）
     - 用户名
     - 角色
     - 公司名称/联系人
     - 客户编号
     - 管理员备注
     - 状态（启用/禁用）
     - 创建时间
     - 操作按钮（编辑、删除、重置密码、禁用/启用）
  
  2. 创建用户
     - 用户名（必填）
     - 密码（必填）
     - 角色（必选：客户/生产跟单/管理员）
     - 客户编号（客户必填）
     - 公司名称
     - 联系人姓名
     - 邮箱
     - 电话
     - 管理员备注
     - 订单类型权限（仅生产跟单）
  
  3. 编辑用户
     - 所有字段可编辑
     - 管理员备注（仅管理员可见和编辑）
     - 订单类型权限（仅生产跟单）
  
  4. 删除用户
     - 软删除（设置 is_active = false）
     - 或硬删除（需要确认）
  
  5. 重置密码
     - 管理员可以重置任何用户的密码
  
  6. 启用/禁用用户
     - 禁用后用户无法登录

### 3.3 筛选和搜索
- 按角色筛选（客户/生产跟单/管理员）
- 按状态筛选（启用/禁用）
- 按用户名/公司名称搜索
- 按客户编号搜索

## 四、后端API设计

### 4.1 用户个人中心API
```
GET    /api/users/profile          - 获取当前用户信息
PUT    /api/users/profile          - 更新当前用户信息
PUT    /api/users/profile/password - 修改当前用户密码
```

### 4.2 用户管理API（仅管理员）
```
GET    /api/users                  - 获取用户列表（支持筛选和搜索）
GET    /api/users/:id              - 获取用户详情
POST   /api/users                   - 创建用户
PUT    /api/users/:id               - 更新用户信息
DELETE /api/users/:id               - 删除用户（软删除）
PUT    /api/users/:id/password      - 重置用户密码
PUT    /api/users/:id/status        - 启用/禁用用户
```

## 五、前端页面设计

### 5.1 个人中心页面（/profile）
- 表单展示当前用户信息
- 可编辑字段：联系人姓名、邮箱、电话、密码
- 只读字段：用户名、角色、客户编号等

### 5.2 用户管理页面（/users，仅管理员）
- **顶部操作栏**：
  - 创建用户按钮
  - 筛选器（角色、状态）
  - 搜索框
  
- **用户列表表格**：
  - 用户名
  - 角色（标签显示）
  - 公司名称/联系人
  - 客户编号
  - 管理员备注（鼠标悬停显示完整内容）
  - 状态（启用/禁用标签）
  - 创建时间
  - 操作列（编辑、删除、重置密码、启用/禁用）
  
- **创建/编辑用户对话框**：
  - 基本信息表单
  - 根据角色动态显示字段
  - 生产跟单显示订单类型权限选择（多选）

## 六、权限控制

### 6.1 用户修改自己信息
- ✅ 可以修改：contact_name, email, phone, password
- ❌ 不能修改：username, customer_code, company_name, role, admin_notes

### 6.2 管理员管理用户
- ✅ 可以查看所有用户
- ✅ 可以创建任何角色的用户
- ✅ 可以编辑所有用户信息（包括 admin_notes）
- ✅ 可以删除/禁用用户
- ✅ 可以重置用户密码
- ✅ 可以为生产跟单设置订单类型权限

## 七、实施步骤

1. **数据库迁移**：添加 admin_notes 字段
2. **后端开发**：
   - 创建用户管理控制器（userController.ts）
   - 添加用户个人中心API
   - 添加用户管理API
   - 更新路由
3. **前端开发**：
   - 创建个人中心页面
   - 创建用户管理页面
   - 添加侧边栏菜单项
   - 创建用户创建/编辑对话框
4. **测试**：测试所有功能

## 八、数据安全

1. **密码安全**：
   - 密码必须加密存储
   - 重置密码需要生成新密码
   - 用户修改密码需要验证旧密码

2. **权限验证**：
   - 所有API都需要验证用户权限
   - 用户只能修改自己的信息
   - 管理员才能管理其他用户

3. **数据验证**：
   - 用户名唯一性验证
   - 客户编号唯一性验证（客户角色）
   - 邮箱格式验证
   - 电话格式验证

## 九、UI/UX建议

1. **个人中心**：
   - 简洁的表单布局
   - 密码修改单独一个区域
   - 保存后显示成功提示

2. **用户管理**：
   - 表格支持排序
   - 支持批量操作（可选）
   - 删除操作需要二次确认
   - 管理员备注支持富文本（可选）

3. **创建/编辑用户**：
   - 根据角色动态显示/隐藏字段
   - 表单验证提示清晰
   - 创建成功后自动刷新列表

