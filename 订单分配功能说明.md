# 订单分配功能说明

## ✅ 已完成的功能

### 1. 数据库扩展
- ✅ 在 `orders` 表中添加了 `assigned_to` 字段（分配给哪个生产跟单）
- ✅ 添加了相应的索引

### 2. 后端实现
- ✅ 添加了 `getProductionManagers` 接口：获取所有生产跟单列表
- ✅ 添加了 `assignOrderToProductionManager` 接口：分配订单给生产跟单
- ✅ 修改了生产跟单的订单查询逻辑：
  - 生产跟单只能查看分配给自己的订单（`assigned_to = user.userId`）
  - 不再按订单类型权限过滤，而是按分配过滤

### 3. 前端实现
- ✅ 在订单列表中添加了"分配"按钮（仅管理员可见）
- ✅ 添加了分配订单对话框：
  - 显示订单编号和订单类型
  - 下拉选择生产跟单
  - 自动过滤无权限的生产跟单（根据订单类型）
  - 支持取消分配（留空）
- ✅ 在桌面端和移动端都添加了分配按钮

## 🎯 功能说明

### 管理员操作流程

1. **查看订单列表**：管理员可以看到所有订单
2. **分配订单**：
   - 点击订单操作栏中的"分配"按钮
   - 在弹出的对话框中选择生产跟单
   - 系统会自动过滤掉没有权限处理该订单类型的生产跟单
   - 可以留空来取消分配
3. **验证分配**：
   - 系统会验证订单类型是否在生产跟单的权限范围内
   - 如果不在范围内，会提示错误

### 生产跟单查看流程

1. **登录系统**：生产跟单登录后
2. **查看订单**：只能看到分配给自己的订单
3. **订单详情**：只能查看分配给自己的订单详情

## 📋 权限逻辑

### 订单分配规则

1. **管理员**：
   - 可以查看所有订单
   - 可以将订单分配给任何生产跟单
   - 系统会验证订单类型是否在生产跟单的权限范围内

2. **生产跟单**：
   - 只能查看分配给自己的订单（`assigned_to = user.userId`）
   - 不能查看未分配的订单
   - 不能查看分配给其他生产跟单的订单

3. **客户**：
   - 只能查看自己的订单
   - 不受分配影响

## 🔧 使用示例

### 分配订单

1. 管理员登录系统
2. 进入订单列表页面
3. 找到要分配的订单，点击"分配"按钮
4. 在对话框中选择生产跟单
5. 点击"确定"完成分配

### 取消分配

1. 在分配对话框中，清空选择的生产跟单
2. 点击"确定"即可取消分配

## ⚠️ 注意事项

1. **订单类型验证**：
   - 系统会自动验证订单类型是否在生产跟单的权限范围内
   - 如果订单类型为"必发"，只能分配给有"必发"权限的生产跟单
   - 如果订单类型为"散单"，只能分配给有"散单"权限的生产跟单
   - 如果订单类型为"拍照"，只能分配给有"拍照"权限的生产跟单

2. **数据迁移**：
   - 需要执行数据库迁移脚本，添加 `assigned_to` 字段
   - 现有订单的 `assigned_to` 默认为 `NULL`（未分配）

3. **生产跟单权限**：
   - 生产跟单的 `assigned_order_types` 字段决定了他们可以处理哪些订单类型
   - 只有管理员可以修改生产跟单的权限

## 🚀 后续建议

1. 在订单列表中显示"已分配给"信息
2. 添加批量分配功能
3. 添加分配历史记录
4. 在订单详情页面显示分配信息

