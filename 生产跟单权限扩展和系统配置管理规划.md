# 生产跟单权限扩展和系统配置管理规划

## 一、需求概述

### 1.1 生产跟单权限扩展
**目标**：让生产跟单能够更新订单的关键信息，方便管理员了解订单状态和问题。

**新增权限**：
- ✅ 可以修改订单的"是否完成"状态
- ✅ 可以修改订单的"可出货"状态
- ✅ 可以修改订单的"预计出货日期"
- ✅ 可以修改订单的"备注"（情况备注）
- ❌ 不能修改：订单状态、订单类型、客户信息、内部备注

### 1.2 系统配置管理（动态配置）
**目标**：管理员可以通过界面配置系统参数，避免频繁修改代码。

**可配置项**：
1. **角色管理**：新增、编辑、删除角色
2. **订单类型管理**：新增、编辑、删除订单类型
3. **订单状态管理**：新增、编辑、删除订单状态
4. **权限配置**：为角色配置权限（哪些角色可以执行哪些操作）

## 二、数据库设计

### 2.1 系统配置表

```sql
-- 系统配置表
CREATE TABLE IF NOT EXISTS system_configs (
    id SERIAL PRIMARY KEY,
    config_key VARCHAR(100) UNIQUE NOT NULL, -- 配置键，如：'roles', 'order_types', 'order_statuses'
    config_value JSONB NOT NULL, -- 配置值，JSON格式
    description TEXT, -- 配置说明
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 角色配置示例
-- config_key: 'roles'
-- config_value: [
--   {"value": "admin", "label": "管理员", "permissions": ["all"]},
--   {"value": "production_manager", "label": "生产跟单", "permissions": ["view_orders", "update_order_status"]},
--   {"value": "customer", "label": "客户", "permissions": ["view_own_orders"]}
-- ]

-- 订单类型配置示例
-- config_key: 'order_types'
-- config_value: [
--   {"value": "required", "label": "必发"},
--   {"value": "scattered", "label": "散单"},
--   {"value": "photo", "label": "拍照"}
-- ]

-- 订单状态配置示例
-- config_key: 'order_statuses'
-- config_value: [
--   {"value": "pending", "label": "待处理"},
--   {"value": "in_production", "label": "生产中"},
--   {"value": "completed", "label": "已完成"},
--   {"value": "shipped", "label": "已发货"},
--   {"value": "cancelled", "label": "已取消"}
-- ]

-- 权限配置示例
-- config_key: 'role_permissions'
-- config_value: {
--   "production_manager": {
--     "orders": {
--       "can_update_completed": true,
--       "can_update_can_ship": true,
--       "can_update_estimated_ship_date": true,
--       "can_update_notes": true,
--       "can_update_status": false,
--       "can_update_order_type": false,
--       "can_view_internal_notes": false
--     }
--   }
-- }
```

### 2.2 索引
```sql
CREATE INDEX IF NOT EXISTS idx_system_configs_config_key ON system_configs(config_key);
```

## 三、功能设计

### 3.1 生产跟单权限扩展

#### 后端实现
- 修改 `updateOrder` 接口，允许生产跟单更新特定字段
- 添加权限检查中间件或函数
- 生产跟单只能更新：
  - `is_completed`
  - `can_ship`
  - `estimated_ship_date`
  - `notes`（情况备注）

#### 前端实现
- 在订单列表和订单详情页面，为生产跟单显示可编辑的字段
- 使用与管理员相同的UI组件（开关、日期选择器、文本输入）

### 3.2 系统配置管理

#### 配置管理页面（仅管理员）
1. **角色管理**
   - 列表显示所有角色
   - 创建新角色（value, label, permissions）
   - 编辑角色
   - 删除角色（需要检查是否有用户使用）

2. **订单类型管理**
   - 列表显示所有订单类型
   - 创建新订单类型（value, label）
   - 编辑订单类型
   - 删除订单类型（需要检查是否有订单使用）

3. **订单状态管理**
   - 列表显示所有订单状态
   - 创建新订单状态（value, label）
   - 编辑订单状态
   - 删除订单状态（需要检查是否有订单使用）

4. **权限配置**
   - 为每个角色配置权限
   - 权限包括：
     - 订单相关权限
     - 催货记录相关权限
     - 用户管理权限
     - 系统配置权限

#### 配置读取机制
- 系统启动时从数据库加载配置
- 提供配置缓存机制
- 配置更新时刷新缓存

## 四、API设计

### 4.1 系统配置API（仅管理员）

```
GET    /api/configs                    - 获取所有配置
GET    /api/configs/:key                - 获取指定配置
POST   /api/configs                    - 创建配置
PUT    /api/configs/:key                - 更新配置
DELETE /api/configs/:key                - 删除配置

GET    /api/configs/roles               - 获取角色列表
POST   /api/configs/roles               - 创建角色
PUT    /api/configs/roles/:value        - 更新角色
DELETE /api/configs/roles/:value        - 删除角色

GET    /api/configs/order-types         - 获取订单类型列表
POST   /api/configs/order-types         - 创建订单类型
PUT    /api/configs/order-types/:value  - 更新订单类型
DELETE /api/configs/order-types/:value  - 删除订单类型

GET    /api/configs/order-statuses      - 获取订单状态列表
POST   /api/configs/order-statuses      - 创建订单状态
PUT    /api/configs/order-statuses/:value - 更新订单状态
DELETE /api/configs/order-statuses/:value - 删除订单状态

GET    /api/configs/permissions          - 获取权限配置
PUT    /api/configs/permissions          - 更新权限配置
```

### 4.2 订单更新权限调整

```
PUT /api/orders/:id
- 管理员：可以更新所有字段
- 生产跟单：只能更新 is_completed, can_ship, estimated_ship_date, notes
- 客户：不能更新订单
```

## 五、实施步骤

### 阶段一：生产跟单权限扩展
1. ✅ 修改后端订单更新接口，添加权限检查
2. ✅ 更新前端订单列表和详情页面，为生产跟单显示可编辑字段
3. ✅ 测试生产跟单的订单更新功能

### 阶段二：系统配置管理（基础）
1. ✅ 创建系统配置表
2. ✅ 创建配置管理控制器和API
3. ✅ 创建配置管理前端页面
4. ✅ 实现配置的读取和缓存机制

### 阶段三：动态配置应用
1. ✅ 修改代码，从配置表读取角色、订单类型、订单状态
2. ✅ 修改权限检查，从配置表读取权限配置
3. ✅ 更新前端，动态显示选项

### 阶段四：配置验证和保护
1. ✅ 添加配置验证（不能删除正在使用的配置）
2. ✅ 添加配置备份机制
3. ✅ 添加配置变更日志

## 六、技术实现细节

### 6.1 配置缓存机制

```typescript
// 配置缓存类
class ConfigCache {
  private cache: Map<string, any> = new Map();
  private cacheTime: Map<string, number> = new Map();
  private TTL = 5 * 60 * 1000; // 5分钟

  async get(key: string): Promise<any> {
    // 检查缓存
    if (this.cache.has(key)) {
      const time = this.cacheTime.get(key) || 0;
      if (Date.now() - time < this.TTL) {
        return this.cache.get(key);
      }
    }
    
    // 从数据库加载
    const config = await loadFromDatabase(key);
    this.cache.set(key, config);
    this.cacheTime.set(key, Date.now());
    return config;
  }

  invalidate(key?: string) {
    if (key) {
      this.cache.delete(key);
      this.cacheTime.delete(key);
    } else {
      this.cache.clear();
      this.cacheTime.clear();
    }
  }
}
```

### 6.2 权限检查中间件

```typescript
// 检查用户是否有权限执行某个操作
function checkPermission(
  user: User,
  resource: string,
  action: string
): boolean {
  const permissions = getRolePermissions(user.role);
  return permissions[resource]?.[action] === true;
}
```

### 6.3 动态选项生成

```typescript
// 从配置表获取订单类型选项
async function getOrderTypeOptions() {
  const config = await configCache.get('order_types');
  return config.map((item: any) => ({
    label: item.label,
    value: item.value,
  }));
}
```

## 七、数据迁移

### 7.1 初始化配置数据

```sql
-- 初始化角色配置
INSERT INTO system_configs (config_key, config_value, description)
VALUES (
  'roles',
  '[
    {"value": "admin", "label": "管理员"},
    {"value": "production_manager", "label": "生产跟单"},
    {"value": "customer", "label": "客户"}
  ]'::jsonb,
  '系统角色配置'
);

-- 初始化订单类型配置
INSERT INTO system_configs (config_key, config_value, description)
VALUES (
  'order_types',
  '[
    {"value": "required", "label": "必发"},
    {"value": "scattered", "label": "散单"},
    {"value": "photo", "label": "拍照"}
  ]'::jsonb,
  '订单类型配置'
);

-- 初始化订单状态配置
INSERT INTO system_configs (config_key, config_value, description)
VALUES (
  'order_statuses',
  '[
    {"value": "pending", "label": "待处理"},
    {"value": "in_production", "label": "生产中"},
    {"value": "completed", "label": "已完成"},
    {"value": "shipped", "label": "已发货"},
    {"value": "cancelled", "label": "已取消"}
  ]'::jsonb,
  '订单状态配置'
);

-- 初始化权限配置
INSERT INTO system_configs (config_key, config_value, description)
VALUES (
  'role_permissions',
  '{
    "production_manager": {
      "orders": {
        "can_update_completed": true,
        "can_update_can_ship": true,
        "can_update_estimated_ship_date": true,
        "can_update_notes": true,
        "can_update_status": false,
        "can_update_order_type": false,
        "can_view_internal_notes": false
      }
    }
  }'::jsonb,
  '角色权限配置'
);
```

## 八、前端页面设计

### 8.1 系统配置管理页面（/configs，仅管理员）

**标签页结构**：
1. **角色管理**标签页
   - 角色列表表格
   - 创建/编辑角色对话框
   - 删除角色（带验证）

2. **订单类型管理**标签页
   - 订单类型列表表格
   - 创建/编辑订单类型对话框
   - 删除订单类型（带验证）

3. **订单状态管理**标签页
   - 订单状态列表表格
   - 创建/编辑订单状态对话框
   - 删除订单状态（带验证）

4. **权限配置**标签页
   - 权限配置表单（按角色分组）
   - 权限树形结构或复选框组

### 8.2 订单页面调整

**订单列表和详情页面**：
- 生产跟单可以看到并编辑：
  - 是否完成（开关）
  - 可出货（开关）
  - 预计出货日期（日期选择器）
  - 备注（文本输入）

## 九、安全考虑

1. **配置验证**：
   - 不能删除正在使用的配置（有订单使用该类型/状态）
   - 不能删除有用户使用的角色
   - 配置值格式验证

2. **权限验证**：
   - 所有配置操作都需要管理员权限
   - 配置变更需要记录日志

3. **数据完整性**：
   - 删除配置前检查关联数据
   - 提供配置备份功能

## 十、实施优先级

### 高优先级（立即实施）
1. ✅ 生产跟单权限扩展（允许更新订单关键信息）
2. ✅ 系统配置表创建和基础API

### 中优先级（第二阶段）
3. ✅ 配置管理前端页面
4. ✅ 动态配置读取机制

### 低优先级（第三阶段）
5. ✅ 配置验证和保护机制
6. ✅ 配置变更日志
7. ✅ 配置导入/导出功能

## 十一、注意事项

1. **向后兼容**：
   - 现有代码需要支持从配置表读取，也要支持硬编码的默认值
   - 配置表为空时使用默认配置

2. **性能考虑**：
   - 配置需要缓存，避免频繁查询数据库
   - 配置更新时清除缓存

3. **用户体验**：
   - 配置管理界面要直观易用
   - 提供配置预览功能
   - 配置变更要有明确的提示和确认
   - 删除操作要有二次确认

4. **测试策略**：
   - 单元测试：配置读取、权限检查
   - 集成测试：配置管理API
   - 端到端测试：生产跟单更新订单流程

## 十二、详细实施计划

### 12.1 阶段一：生产跟单权限扩展（预计2-3天）

#### 步骤1：数据库检查
- 确认 `orders` 表已有以下字段：
  - `is_completed` (BOOLEAN)
  - `can_ship` (BOOLEAN)
  - `estimated_ship_date` (DATE)
  - `notes` (TEXT) - 情况备注
  - `internal_notes` (TEXT) - 内部备注（生产跟单不可见）

#### 步骤2：后端权限检查
- 修改 `backend/src/controllers/orderController.ts` 的 `updateOrder` 函数
- 添加权限检查逻辑：
  ```typescript
  if (user.role === 'production_manager') {
    // 只允许更新特定字段
    const allowedFields = ['is_completed', 'can_ship', 'estimated_ship_date', 'notes'];
    // 过滤掉不允许的字段
  }
  ```

#### 步骤3：前端UI调整
- 修改 `frontend/src/views/orders/OrderList.vue`
  - 生产跟单角色显示可编辑的字段
  - 使用 `el-switch` 显示 `is_completed` 和 `can_ship`
  - 使用 `el-date-picker` 显示 `estimated_ship_date`
  - 使用 `el-input` 显示 `notes`
- 修改 `frontend/src/components/OrderEditDialog.vue`
  - 根据用户角色显示/隐藏字段
  - 生产跟单只能看到和编辑允许的字段

#### 步骤4：测试
- 测试生产跟单账号登录后能否更新订单
- 测试生产跟单不能更新不允许的字段
- 测试管理员仍然可以更新所有字段

### 12.2 阶段二：系统配置管理基础（预计3-4天）

#### 步骤1：数据库迁移
- 创建 `database/migrations/002_add_system_configs.sql`
- 创建 `system_configs` 表
- 初始化默认配置数据

#### 步骤2：后端API开发
- 创建 `backend/src/controllers/configController.ts`
  - `getConfigs` - 获取所有配置
  - `getConfigByKey` - 获取指定配置
  - `createConfig` - 创建配置
  - `updateConfig` - 更新配置
  - `deleteConfig` - 删除配置
  - `getRoles` - 获取角色列表
  - `createRole` - 创建角色
  - `updateRole` - 更新角色
  - `deleteRole` - 删除角色
  - `getOrderTypes` - 获取订单类型列表
  - `createOrderType` - 创建订单类型
  - `updateOrderType` - 更新订单类型
  - `deleteOrderType` - 删除订单类型
  - `getOrderStatuses` - 获取订单状态列表
  - `createOrderStatus` - 创建订单状态
  - `updateOrderStatus` - 更新订单状态
  - `deleteOrderStatus` - 删除订单状态
  - `getPermissions` - 获取权限配置
  - `updatePermissions` - 更新权限配置

- 创建 `backend/src/routes/configRoutes.ts`
- 创建 `backend/src/services/configService.ts` - 配置缓存服务

#### 步骤3：前端API服务
- 创建 `frontend/src/api/configs.ts`
- 实现所有配置相关的API调用

#### 步骤4：前端页面开发
- 创建 `frontend/src/views/configs/ConfigManagement.vue`
  - 使用 `el-tabs` 组件创建4个标签页
  - 每个标签页包含列表、创建、编辑、删除功能
- 创建 `frontend/src/views/configs/RoleManagement.vue`（可选，或集成在主页面）
- 创建 `frontend/src/views/configs/OrderTypeManagement.vue`（可选）
- 创建 `frontend/src/views/configs/OrderStatusManagement.vue`（可选）
- 创建 `frontend/src/views/configs/PermissionManagement.vue`（可选）

#### 步骤5：路由配置
- 在 `frontend/src/router/index.ts` 添加配置管理路由
- 添加权限检查（仅管理员）

#### 步骤6：侧边栏菜单
- 在 `frontend/src/components/layouts/MainLayout.vue` 添加"系统配置"菜单项

### 12.3 阶段三：动态配置应用（预计2-3天）

#### 步骤1：配置读取服务
- 实现配置缓存机制
- 系统启动时加载配置
- 提供配置刷新接口

#### 步骤2：代码改造
- 修改所有硬编码的角色、订单类型、订单状态
- 从配置表读取数据
- 提供默认值作为后备

#### 步骤3：权限系统改造
- 修改权限检查逻辑，从配置表读取权限
- 实现动态权限验证

#### 步骤4：前端动态选项
- 修改所有下拉选项，从API获取数据
- 实现选项缓存机制

### 12.4 阶段四：配置验证和保护（预计1-2天）

#### 步骤1：配置验证
- 删除前检查关联数据
- 配置值格式验证
- 必填字段验证

#### 步骤2：配置备份
- 配置变更前自动备份
- 提供配置恢复功能

#### 步骤3：配置日志
- 记录配置变更历史
- 显示变更人和变更时间

## 十三、数据库迁移脚本结构

### 13.1 迁移脚本：002_add_system_configs.sql

```sql
-- 创建系统配置表
CREATE TABLE IF NOT EXISTS system_configs (
    id SERIAL PRIMARY KEY,
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value JSONB NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_system_configs_config_key ON system_configs(config_key);

-- 初始化角色配置
INSERT INTO system_configs (config_key, config_value, description)
VALUES (
  'roles',
  '[
    {"value": "admin", "label": "管理员"},
    {"value": "production_manager", "label": "生产跟单"},
    {"value": "customer", "label": "客户"}
  ]'::jsonb,
  '系统角色配置'
) ON CONFLICT (config_key) DO NOTHING;

-- 初始化订单类型配置
INSERT INTO system_configs (config_key, config_value, description)
VALUES (
  'order_types',
  '[
    {"value": "required", "label": "必发"},
    {"value": "scattered", "label": "散单"},
    {"value": "photo", "label": "拍照"}
  ]'::jsonb,
  '订单类型配置'
) ON CONFLICT (config_key) DO NOTHING;

-- 初始化订单状态配置
INSERT INTO system_configs (config_key, config_value, description)
VALUES (
  'order_statuses',
  '[
    {"value": "pending", "label": "待处理"},
    {"value": "in_production", "label": "生产中"},
    {"value": "completed", "label": "已完成"},
    {"value": "shipped", "label": "已发货"},
    {"value": "cancelled", "label": "已取消"}
  ]'::jsonb,
  '订单状态配置'
) ON CONFLICT (config_key) DO NOTHING;

-- 初始化权限配置
INSERT INTO system_configs (config_key, config_value, description)
VALUES (
  'role_permissions',
  '{
    "admin": {
      "orders": {
        "can_view_all": true,
        "can_create": true,
        "can_update": true,
        "can_delete": true,
        "can_update_completed": true,
        "can_update_can_ship": true,
        "can_update_estimated_ship_date": true,
        "can_update_notes": true,
        "can_update_status": true,
        "can_update_order_type": true,
        "can_view_internal_notes": true
      },
      "reminders": {
        "can_view_all": true,
        "can_create": true,
        "can_update": true,
        "can_delete": true,
        "can_assign": true
      },
      "users": {
        "can_view_all": true,
        "can_create": true,
        "can_update": true,
        "can_delete": true
      },
      "configs": {
        "can_view": true,
        "can_update": true
      }
    },
    "production_manager": {
      "orders": {
        "can_view_assigned": true,
        "can_update_completed": true,
        "can_update_can_ship": true,
        "can_update_estimated_ship_date": true,
        "can_update_notes": true,
        "can_update_status": false,
        "can_update_order_type": false,
        "can_view_internal_notes": false
      },
      "reminders": {
        "can_view_assigned": true,
        "can_create": false,
        "can_update": false,
        "can_delete": false
      }
    },
    "customer": {
      "orders": {
        "can_view_own": true,
        "can_create": true,
        "can_update": false
      }
    }
  }'::jsonb,
  '角色权限配置'
) ON CONFLICT (config_key) DO NOTHING;

-- 创建更新时间触发器
CREATE OR REPLACE FUNCTION update_system_configs_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_system_configs_updated_at
    BEFORE UPDATE ON system_configs
    FOR EACH ROW
    EXECUTE FUNCTION update_system_configs_updated_at();
```

## 十四、API接口详细设计

### 14.1 系统配置基础API

#### GET /api/configs
获取所有配置（仅管理员）

**响应示例**：
```json
{
  "configs": [
    {
      "id": 1,
      "config_key": "roles",
      "config_value": [...],
      "description": "系统角色配置",
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": "2024-01-01T00:00:00Z"
    }
  ]
}
```

#### GET /api/configs/:key
获取指定配置

**响应示例**：
```json
{
  "config": {
    "id": 1,
    "config_key": "roles",
    "config_value": [
      {"value": "admin", "label": "管理员"},
      {"value": "production_manager", "label": "生产跟单"}
    ],
    "description": "系统角色配置"
  }
}
```

#### POST /api/configs
创建配置

**请求体**：
```json
{
  "config_key": "custom_config",
  "config_value": {...},
  "description": "自定义配置"
}
```

#### PUT /api/configs/:key
更新配置

**请求体**：
```json
{
  "config_value": {...},
  "description": "更新后的描述"
}
```

#### DELETE /api/configs/:key
删除配置（需要验证是否在使用）

### 14.2 角色管理API

#### GET /api/configs/roles
获取角色列表

**响应示例**：
```json
{
  "roles": [
    {"value": "admin", "label": "管理员"},
    {"value": "production_manager", "label": "生产跟单"},
    {"value": "customer", "label": "客户"}
  ]
}
```

#### POST /api/configs/roles
创建角色

**请求体**：
```json
{
  "value": "new_role",
  "label": "新角色",
  "permissions": []
}
```

#### PUT /api/configs/roles/:value
更新角色

**请求体**：
```json
{
  "label": "更新后的角色名",
  "permissions": [...]
}
```

#### DELETE /api/configs/roles/:value
删除角色（需要检查是否有用户使用）

### 14.3 订单类型管理API

#### GET /api/configs/order-types
获取订单类型列表

**响应示例**：
```json
{
  "orderTypes": [
    {"value": "required", "label": "必发"},
    {"value": "scattered", "label": "散单"},
    {"value": "photo", "label": "拍照"}
  ]
}
```

#### POST /api/configs/order-types
创建订单类型

**请求体**：
```json
{
  "value": "new_type",
  "label": "新类型"
}
```

#### PUT /api/configs/order-types/:value
更新订单类型

**请求体**：
```json
{
  "label": "更新后的类型名"
}
```

#### DELETE /api/configs/order-types/:value
删除订单类型（需要检查是否有订单使用）

### 14.4 订单状态管理API

#### GET /api/configs/order-statuses
获取订单状态列表

**响应示例**：
```json
{
  "orderStatuses": [
    {"value": "pending", "label": "待处理"},
    {"value": "in_production", "label": "生产中"},
    {"value": "completed", "label": "已完成"}
  ]
}
```

#### POST /api/configs/order-statuses
创建订单状态

**请求体**：
```json
{
  "value": "new_status",
  "label": "新状态"
}
```

#### PUT /api/configs/order-statuses/:value
更新订单状态

**请求体**：
```json
{
  "label": "更新后的状态名"
}
```

#### DELETE /api/configs/order-statuses/:value
删除订单状态（需要检查是否有订单使用）

### 14.5 权限配置API

#### GET /api/configs/permissions
获取权限配置

**响应示例**：
```json
{
  "permissions": {
    "admin": {
      "orders": {
        "can_view_all": true,
        "can_create": true,
        "can_update": true
      }
    },
    "production_manager": {
      "orders": {
        "can_update_completed": true,
        "can_update_can_ship": true
      }
    },
    "customer": {
      "orders": {
        "can_view_own": true
      }
    }
  }
}
```

#### PUT /api/configs/permissions
更新权限配置

**请求体**：
```json
{
  "role": "production_manager",
  "resource": "orders",
  "permissions": {
    "can_update_completed": true,
    "can_update_can_ship": true,
    "can_update_estimated_ship_date": true,
    "can_update_notes": true
  }
}
```

### 14.6 订单更新权限调整API

#### PUT /api/orders/:id
更新订单（权限根据角色动态检查）

**请求体（管理员）**：
```json
{
  "status": "in_production",
  "order_type": "required",
  "is_completed": true,
  "can_ship": true,
  "estimated_ship_date": "2024-01-15",
  "notes": "备注信息",
  "internal_notes": "内部备注"
}
```

**请求体（生产跟单）**：
```json
{
  "is_completed": true,
  "can_ship": true,
  "estimated_ship_date": "2024-01-15",
  "notes": "备注信息"
}
```

**权限检查**：
- 管理员：可以更新所有字段
- 生产跟单：只能更新 `is_completed`, `can_ship`, `estimated_ship_date`, `notes`
- 客户：返回 403 Forbidden

## 十五、配置缓存服务实现

### 15.1 配置服务类设计

```typescript
// backend/src/services/configService.ts
import { pool } from '../config/database';

class ConfigService {
  private cache: Map<string, { data: any; timestamp: number }> = new Map();
  private readonly TTL = 5 * 60 * 1000; // 5分钟缓存

  async getConfig(key: string): Promise<any> {
    // 检查缓存
    const cached = this.cache.get(key);
    if (cached && Date.now() - cached.timestamp < this.TTL) {
      return cached.data;
    }

    // 从数据库加载
    const result = await pool.query(
      'SELECT config_value FROM system_configs WHERE config_key = $1',
      [key]
    );

    if (result.rows.length === 0) {
      return this.getDefaultConfig(key);
    }

    const data = result.rows[0].config_value;
    this.cache.set(key, { data, timestamp: Date.now() });
    return data;
  }

  async setConfig(key: string, value: any): Promise<void> {
    await pool.query(
      `INSERT INTO system_configs (config_key, config_value)
       VALUES ($1, $2)
       ON CONFLICT (config_key) 
       DO UPDATE SET config_value = $2, updated_at = CURRENT_TIMESTAMP`,
      [key, JSON.stringify(value)]
    );
    this.invalidateCache(key);
  }

  invalidateCache(key?: string): void {
    if (key) {
      this.cache.delete(key);
    } else {
      this.cache.clear();
    }
  }

  private getDefaultConfig(key: string): any {
    // 默认配置，用于向后兼容
    const defaults: Record<string, any> = {
      roles: [
        { value: 'admin', label: '管理员' },
        { value: 'production_manager', label: '生产跟单' },
        { value: 'customer', label: '客户' }
      ],
      order_types: [
        { value: 'required', label: '必发' },
        { value: 'scattered', label: '散单' },
        { value: 'photo', label: '拍照' }
      ],
      order_statuses: [
        { value: 'pending', label: '待处理' },
        { value: 'in_production', label: '生产中' },
        { value: 'completed', label: '已完成' },
        { value: 'shipped', label: '已发货' },
        { value: 'cancelled', label: '已取消' }
      ]
    };
    return defaults[key] || null;
  }
}

export const configService = new ConfigService();
```

## 十六、权限检查工具函数

### 16.1 权限检查中间件

```typescript
// backend/src/middleware/permissionCheck.ts
import { Response, NextFunction } from 'express';
import { AuthRequest } from '../types';
import { configService } from '../services/configService';

export async function checkPermission(
  req: AuthRequest,
  res: Response,
  next: NextFunction,
  resource: string,
  action: string
) {
  try {
    const user = req.user;
    if (!user) {
      return res.status(401).json({ error: '未授权' });
    }

    // 管理员拥有所有权限
    if (user.role === 'admin') {
      return next();
    }

    // 获取权限配置
    const permissions = await configService.getConfig('role_permissions');
    const rolePermissions = permissions?.[user.role]?.[resource];

    if (rolePermissions?.[action] === true) {
      return next();
    }

    return res.status(403).json({ error: '权限不足' });
  } catch (error) {
    console.error('权限检查错误:', error);
    return res.status(500).json({ error: '服务器内部错误' });
  }
}

// 使用示例
export const canUpdateOrder = (req: AuthRequest, res: Response, next: NextFunction) => {
  return checkPermission(req, res, next, 'orders', 'can_update');
};
```

## 十七、前端配置管理页面结构

### 17.1 页面组件结构

```
frontend/src/views/configs/
├── ConfigManagement.vue          # 主页面（标签页容器）
├── components/
│   ├── RoleManagement.vue        # 角色管理组件
│   ├── OrderTypeManagement.vue   # 订单类型管理组件
│   ├── OrderStatusManagement.vue # 订单状态管理组件
│   └── PermissionManagement.vue  # 权限配置组件
```

### 17.2 主要功能点

1. **角色管理**：
   - 列表展示（value, label）
   - 创建/编辑对话框
   - 删除前检查用户使用情况

2. **订单类型管理**：
   - 列表展示（value, label）
   - 创建/编辑对话框
   - 删除前检查订单使用情况

3. **订单状态管理**：
   - 列表展示（value, label）
   - 创建/编辑对话框
   - 删除前检查订单使用情况

4. **权限配置**：
   - 按角色分组显示
   - 复选框或开关控制权限
   - 实时保存配置