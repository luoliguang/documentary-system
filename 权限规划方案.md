# 生产跟单权限规划方案

## 一、需求概述

### 1.1 角色定义
- **系统管理员（admin）**：拥有绝对权限，可以查看和管理所有数据
- **生产跟单（production_manager）**：权限介于管理员和客户之间
  - 可以查看分配给他们的订单类型（必发/散单/拍照）
  - 只能查看管理员派送的催货任务
- **客户（customer）**：只能查看自己的订单和催货记录

### 1.2 订单类型
- **必发**：`required`
- **散单**：`scattered`
- **拍照**：`photo`

## 二、数据库结构变更

### 2.1 用户表（users）扩展
```sql
-- 添加生产跟单的订单类型权限字段
ALTER TABLE users 
ADD COLUMN assigned_order_types JSONB DEFAULT '[]'::jsonb;
-- 示例：['required', 'scattered'] 表示该生产跟单可以查看必发和散单类型的订单
```

### 2.2 订单表（orders）扩展
```sql
-- 添加订单类型字段
ALTER TABLE orders 
ADD COLUMN order_type VARCHAR(20) DEFAULT 'required';
-- 可选值：'required'（必发）、'scattered'（散单）、'photo'（拍照）

-- 添加索引
CREATE INDEX IF NOT EXISTS idx_orders_order_type ON orders(order_type);
```

### 2.3 催货记录表（delivery_reminders）扩展
```sql
-- 添加是否为管理员派送任务的标识
ALTER TABLE delivery_reminders 
ADD COLUMN is_admin_assigned BOOLEAN DEFAULT false;
-- true：管理员派送的催货任务，生产跟单可以查看
-- false：客户发起的催货，生产跟单不能查看

-- 添加派送给哪个生产跟单的字段（可选，用于任务分配）
ALTER TABLE delivery_reminders 
ADD COLUMN assigned_to INTEGER REFERENCES users(id);
-- 如果指定了assigned_to，则只有该生产跟单可以看到
```

## 三、后端实现方案

### 3.1 类型定义更新

**backend/src/types/index.ts**
```typescript
export interface User {
  // ... 现有字段
  role: 'customer' | 'admin' | 'production_manager';
  assigned_order_types?: string[]; // 生产跟单的订单类型权限
}

export interface Order {
  // ... 现有字段
  order_type?: 'required' | 'scattered' | 'photo';
}

export interface DeliveryReminder {
  // ... 现有字段
  is_admin_assigned?: boolean; // 是否为管理员派送的任务
  assigned_to?: number; // 分配给哪个生产跟单
}
```

### 3.2 订单查询权限控制

**backend/src/controllers/orderController.ts**

修改 `getOrders` 函数：
- **管理员**：查看所有订单，可以按订单类型筛选
- **生产跟单**：只能查看 `assigned_order_types` 中包含的订单类型
- **客户**：只能查看自己的订单

```typescript
if (user.role === 'production_manager') {
  // 获取该生产跟单的订单类型权限
  const userResult = await pool.query(
    'SELECT assigned_order_types FROM users WHERE id = $1',
    [user.userId]
  );
  const assignedTypes = userResult.rows[0]?.assigned_order_types || [];
  
  if (assignedTypes.length === 0) {
    // 如果没有分配订单类型，返回空列表
    return res.json({ orders: [], pagination: { ... } });
  }
  
  // 只查询分配的订单类型
  whereConditions.push(`o.order_type = ANY($${paramIndex++}::text[])`);
  params.push(assignedTypes);
}
```

### 3.3 催货记录查询权限控制

**backend/src/controllers/reminderController.ts**

修改 `getDeliveryReminders` 函数：
- **管理员**：查看所有催货记录
- **生产跟单**：只能查看 `is_admin_assigned = true` 的记录，如果指定了 `assigned_to`，则只能查看分配给自己的
- **客户**：只能查看自己的催货记录

```typescript
if (user.role === 'production_manager') {
  whereConditions.push(`dr.is_admin_assigned = true`);
  // 如果指定了assigned_to，则只显示分配给自己的
  whereConditions.push(`(dr.assigned_to IS NULL OR dr.assigned_to = $${paramIndex++})`);
  params.push(user.userId);
}
```

### 3.4 管理员派送催货任务

新增接口：管理员可以将催货记录派送给生产跟单

```typescript
// 管理员派送催货任务给生产跟单
export const assignReminderToProductionManager = async (
  req: AuthRequest,
  res: Response
) => {
  // 只有管理员可以操作
  if (req.user!.role !== 'admin') {
    return res.status(403).json({ error: '无权操作' });
  }
  
  const { id } = req.params;
  const { assigned_to } = req.body;
  
  // 更新催货记录
  await pool.query(
    `UPDATE delivery_reminders 
     SET is_admin_assigned = true, assigned_to = $1 
     WHERE id = $2`,
    [assigned_to, id]
  );
  
  // 返回成功
};
```

## 四、前端实现方案

### 4.1 类型定义更新

**frontend/src/types/index.ts**
```typescript
export interface User {
  // ... 现有字段
  role: 'customer' | 'admin' | 'production_manager';
  assigned_order_types?: string[];
}

export interface Order {
  // ... 现有字段
  order_type?: 'required' | 'scattered' | 'photo';
}

export interface DeliveryReminder {
  // ... 现有字段
  is_admin_assigned?: boolean;
  assigned_to?: number;
}
```

### 4.2 Auth Store 更新

**frontend/src/stores/auth.ts**
```typescript
const isAdmin = computed(() => user.value?.role === 'admin');
const isCustomer = computed(() => user.value?.role === 'customer');
const isProductionManager = computed(() => user.value?.role === 'production_manager');
```

### 4.3 UI 权限控制

**订单列表（OrderList.vue）**
- 生产跟单可以看到订单列表，但只能看到分配的订单类型
- 订单类型筛选器：根据 `assigned_order_types` 显示可选的订单类型

**催货记录（ReminderList.vue）**
- 生产跟单只能看到管理员派送的催货任务（`is_admin_assigned = true`）
- 隐藏客户公司名称（生产跟单不需要看到）
- 不显示"回复"按钮（生产跟单不能回复）

**管理员功能**
- 在催货记录中添加"派送给生产跟单"功能
- 在用户管理中设置生产跟单的 `assigned_order_types`

## 五、实施步骤

1. **数据库迁移**
   - 执行 SQL 脚本添加新字段
   - 更新现有数据（设置默认值）

2. **后端开发**
   - 更新类型定义
   - 修改订单查询逻辑
   - 修改催货记录查询逻辑
   - 添加管理员派送任务接口

3. **前端开发**
   - 更新类型定义
   - 更新 Auth Store
   - 更新 UI 权限判断
   - 添加订单类型筛选
   - 添加管理员派送任务功能

4. **测试**
   - 测试生产跟单的订单查看权限
   - 测试生产跟单的催货记录查看权限
   - 测试管理员派送任务功能

## 六、权限矩阵

| 功能 | 管理员 | 生产跟单 | 客户 |
|------|--------|----------|------|
| 查看所有订单 | ✅ | ❌ | ❌ |
| 查看分配的订单类型 | ✅ | ✅ | ❌ |
| 查看自己的订单 | ✅ | ❌ | ✅ |
| 创建订单 | ✅ | ❌ | ❌ |
| 编辑订单 | ✅ | ❌ | ❌ |
| 查看所有催货记录 | ✅ | ❌ | ❌ |
| 查看管理员派送的催货任务 | ✅ | ✅ | ❌ |
| 查看自己的催货记录 | ✅ | ❌ | ✅ |
| 创建催货记录 | ❌ | ❌ | ✅ |
| 回复催货记录 | ✅ | ❌ | ❌ |
| 派送催货任务 | ✅ | ❌ | ❌ |

## 七、注意事项

1. **数据迁移**：需要为现有订单设置默认的 `order_type`
2. **向后兼容**：确保现有客户和管理员功能不受影响
3. **权限验证**：所有接口都需要验证用户角色和权限
4. **UI 提示**：生产跟单登录后，需要明确显示其权限范围

