# 数据库迁移执行指南

## 📋 迁移脚本说明

迁移脚本位置：`database/migrations/001_add_production_manager_features.sql`

该脚本会：
1. 在 `users` 表中添加 `assigned_order_types` 字段
2. 在 `orders` 表中添加 `order_type` 字段
3. 在 `delivery_reminders` 表中添加 `is_admin_assigned` 和 `assigned_to` 字段
4. 创建必要的索引
5. 为现有订单设置默认订单类型（必发）

## 🚀 执行方法

### 方法一：使用 psql 命令行（推荐）

#### Windows PowerShell

```powershell
# 1. 进入项目目录
cd D:\Data\Data\GitHub\fangdu-website-follow

# 2. 执行迁移脚本（需要替换为你的数据库连接信息）
psql -U 数据库用户名 -d 数据库名 -h localhost -p 5432 -f database/migrations/001_add_production_manager_features.sql

# 示例（如果数据库用户名是 postgres，数据库名是 fangdu_db）：
psql -U postgres -d fangdu_db -h localhost -p 5432 -f database/migrations/001_add_production_manager_features.sql
```

#### Windows CMD

```cmd
# 1. 进入项目目录
cd D:\Data\Data\GitHub\fangdu-website-follow

# 2. 执行迁移脚本
psql -U 数据库用户名 -d 数据库名 -h localhost -p 5432 -f database\migrations\001_add_production_manager_features.sql
```

#### 如果需要输入密码

```powershell
# 使用环境变量设置密码（推荐）
$env:PGPASSWORD="你的数据库密码"
psql -U postgres -d fangdu_db -h localhost -p 5432 -f database/migrations/001_add_production_manager_features.sql
```

### 方法二：使用数据库客户端工具

#### pgAdmin

1. 打开 pgAdmin
2. 连接到你的数据库服务器
3. 右键点击目标数据库 → **Query Tool**（查询工具）
4. 打开迁移脚本文件：`database/migrations/001_add_production_manager_features.sql`
5. 复制所有内容到查询工具
6. 点击 **Execute**（执行）按钮（或按 F5）

#### DBeaver

1. 打开 DBeaver
2. 连接到你的数据库
3. 右键点击数据库 → **SQL Editor** → **New SQL Script**
4. 打开迁移脚本文件并复制内容
5. 粘贴到 SQL 编辑器中
6. 点击 **Execute SQL Script**（执行 SQL 脚本）按钮（或按 Ctrl+Enter）

#### Navicat / DataGrip / 其他工具

1. 连接到数据库
2. 打开 SQL 查询窗口
3. 打开迁移脚本文件并执行

### 方法三：使用 Node.js 脚本（自动化）

创建一个执行脚本：

```javascript
// scripts/run-migration.js
const { Pool } = require('pg');
const fs = require('fs');
const path = require('path');

const pool = new Pool({
  user: process.env.DB_USER || 'postgres',
  host: process.env.DB_HOST || 'localhost',
  database: process.env.DB_NAME || 'fangdu_db',
  password: process.env.DB_PASSWORD,
  port: process.env.DB_PORT || 5432,
});

async function runMigration() {
  const client = await pool.connect();
  try {
    const sql = fs.readFileSync(
      path.join(__dirname, '../database/migrations/001_add_production_manager_features.sql'),
      'utf8'
    );
    
    await client.query('BEGIN');
    await client.query(sql);
    await client.query('COMMIT');
    
    console.log('✅ 迁移执行成功！');
  } catch (error) {
    await client.query('ROLLBACK');
    console.error('❌ 迁移执行失败：', error);
    process.exit(1);
  } finally {
    client.release();
    await pool.end();
  }
}

runMigration();
```

执行：
```bash
node scripts/run-migration.js
```

## 🔍 验证迁移是否成功

执行以下 SQL 查询来验证：

```sql
-- 1. 检查 users 表是否有 assigned_order_types 字段
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'users' AND column_name = 'assigned_order_types';

-- 2. 检查 orders 表是否有 order_type 字段
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'orders' AND column_name = 'order_type';

-- 3. 检查 delivery_reminders 表是否有新字段
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'delivery_reminders' 
AND column_name IN ('is_admin_assigned', 'assigned_to');

-- 4. 检查索引是否创建
SELECT indexname 
FROM pg_indexes 
WHERE tablename IN ('orders', 'delivery_reminders')
AND indexname LIKE '%order_type%' OR indexname LIKE '%admin_assigned%' OR indexname LIKE '%assigned_to%';
```

如果所有查询都返回了预期的结果，说明迁移成功！

## ⚠️ 注意事项

1. **备份数据库**：执行迁移前，建议先备份数据库
   ```bash
   pg_dump -U postgres -d fangdu_db > backup_before_migration.sql
   ```

2. **使用 IF NOT EXISTS**：脚本使用了 `IF NOT EXISTS`，可以安全地重复执行

3. **现有数据**：所有现有订单的 `order_type` 会被设置为 `'required'`（必发）

4. **生产环境**：在生产环境执行前，建议先在测试环境验证

## 🐛 常见问题

### 问题1：找不到 psql 命令

**解决方案**：
- 确保 PostgreSQL 已安装
- 将 PostgreSQL 的 bin 目录添加到系统 PATH
- 或使用完整路径：`C:\Program Files\PostgreSQL\15\bin\psql.exe`

### 问题2：权限不足

**解决方案**：
- 确保使用的数据库用户有 ALTER TABLE 权限
- 或者使用超级用户（postgres）执行

### 问题3：连接被拒绝

**解决方案**：
- 检查 PostgreSQL 服务是否运行
- 检查防火墙设置
- 检查连接参数（host, port, username, password）

## 📞 需要帮助？

如果遇到问题，请检查：
1. 数据库连接信息是否正确
2. 数据库用户是否有足够权限
3. PostgreSQL 服务是否正常运行
4. 查看错误日志获取详细信息

